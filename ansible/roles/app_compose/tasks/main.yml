---
- name: Resolve compose settings
  ansible.builtin.set_fact:
    compose_project_dir_effective: >-
      {{
        compose_project_dir
        | default(bootstrap_env_dict.COMPOSE_PROJECT_DIR | default(lookup('env', 'COMPOSE_PROJECT_DIR') | default('/srv/app', true), true), true)
      }}
    edge_network_name_effective: >-
      {{
        edge_network_name
        | default(bootstrap_env_dict.EDGE_NETWORK_NAME | default(lookup('env', 'EDGE_NETWORK_NAME') | default('edge', true), true), true)
      }}
    app_image_effective: >-
      {{
        app_image
        | default(bootstrap_env_dict.APP_IMAGE | default(lookup('env', 'APP_IMAGE') | default('', true), true), true)
      }}
    app_container_name_effective: >-
      {{
        app_container_name
        | default(bootstrap_env_dict.APP_CONTAINER_NAME | default(lookup('env', 'APP_CONTAINER_NAME') | default('pw_app1', true), true), true)
      }}
    app_port_publish_effective: >-
      {{
        app_port_publish
        | default(bootstrap_env_dict.APP_PORT_PUBLISH | default(lookup('env', 'APP_PORT_PUBLISH') | default('', true), true), true)
      }}
    cloudflare_tunnel_token_effective: >-
      {{
        cloudflare_tunnel_token
        | default(bootstrap_env_dict.CLOUDFLARE_TUNNEL_TOKEN | default(lookup('env', 'CLOUDFLARE_TUNNEL_TOKEN') | default('', true), true), true)
      }}
  no_log: true

- name: Fail when APP_IMAGE is missing
  ansible.builtin.fail:
    msg: "APP_IMAGE is required to build the compose stack."
  when: app_image_effective | length == 0

- name: Ensure compose project directory
  ansible.builtin.file:
    path: "{{ compose_project_dir_effective }}"
    state: directory
    mode: "0755"

- name: Write docker-compose.yml
  ansible.builtin.copy:
    dest: "{{ compose_project_dir_effective }}/docker-compose.yml"
    mode: "0644"
    owner: root
    group: root
    content: |
      version: "3.8"

      services:
        app1:
          image: {{ app_image_effective }}
          container_name: {{ app_container_name_effective }}
          restart: unless-stopped
          env_file:
            - .env
          expose:
            - "8080"
      {% if app_port_publish_effective | length > 0 %}
          ports:
            - "{{ app_port_publish_effective }}"
      {% endif %}
          networks:
            - edge
        cloudflared:
          image: cloudflare/cloudflared:latest
          command: tunnel --no-autoupdate run --token ${CLOUDFLARE_TUNNEL_TOKEN}
          environment:
            TUNNEL_TOKEN: ${CLOUDFLARE_TUNNEL_TOKEN}
          restart: unless-stopped
          networks:
            - edge

      networks:
        edge:
          external: true
          name: {{ edge_network_name_effective }}

- name: Write .env if missing
  ansible.builtin.copy:
    dest: "{{ compose_project_dir_effective }}/.env"
    mode: "0600"
    owner: root
    group: root
    force: false
    content: |
      # App environment variables
      # EXAMPLE_KEY=value
      #
      # Cloudflared token (set value manually or via automation)
      # CLOUDFLARE_TUNNEL_TOKEN=

- name: Write systemd unit
  ansible.builtin.copy:
    dest: /etc/systemd/system/app-compose.service
    mode: "0644"
    owner: root
    group: root
    content: |
      [Unit]
      Description=App Compose Stack
      After=docker.service network-online.target
      Wants=network-online.target

      [Service]
      Type=oneshot
      WorkingDirectory={{ compose_project_dir_effective }}
      ExecStart=/usr/bin/docker compose -f {{ compose_project_dir_effective }}/docker-compose.yml --env-file {{ compose_project_dir_effective }}/.env up -d
      ExecStop=/usr/bin/docker compose -f {{ compose_project_dir_effective }}/docker-compose.yml --env-file {{ compose_project_dir_effective }}/.env down
      Restart=on-failure
      RestartSec=5
      RemainAfterExit=true

      [Install]
      WantedBy=multi-user.target

- name: Enable and start compose service
  ansible.builtin.systemd:
    name: app-compose.service
    state: started
    enabled: true
    daemon_reload: true

- name: Log compose status
  ansible.builtin.command:
    cmd: "/usr/bin/docker compose -f {{ compose_project_dir_effective }}/docker-compose.yml ps"
  register: compose_status
  changed_when: false

- name: Show compose status
  ansible.builtin.debug:
    msg: "{{ compose_status.stdout }}"
